<!-- views/pamonitoring.ejs.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Monitoring</title>

    <% include ../partials/head %>

    <script src="/angular/angular.js"></script>
    <script src="/angular-google-chart/ng-google-chart.js"></script>


    <script type="text/javascript" src="//www.google.com/jsapi"></script>
</head>

<script type="text/javascript">
  //-------------------------------------------------------------------------------------
  var angularApp = angular.module('myApp', []);
  angularApp.controller('getSensorCtrl', function ($scope, $http) {
    $scope.mSensorList = [];

    $scope.getSensorList = function () {
      console.log("getSensorList!");
      $http({
        method: 'GET',
        url: 'getallsensorparams'
      }).then(function (response) {
        $scope.mSensorList = response.data;
        $scope.selSensor = $scope.mSensorList[4];   //set initial value
        $scope.updateSelectBox();                   //simulate select for initial value
      }, function (error) {
        console.log("getSensorList ERROR: " + error);
      });
    };
    $scope.getSensorList();  //initial data load

    $scope.updateSelectBox = function () {
      let selSensID = $scope.selSensor.id;
      let selSensName = $scope.selSensor.sensor_name;
      console.log("updateSelectBox: selSensor[" + selSensID + "] -> " + selSensName);
      loadSensorData(selSensID, selSensName);
    }


    //********************************************************************************************************************
    // DATEPICKER PART

    $scope.today = function () {
      $scope.dt = new Date();
    };
    $scope.today();

    $scope.clear = function () {
      $scope.dt = null;
    };

    $scope.inlineOptions = {
      customClass: getDayClass,
      minDate: new Date(),
      showWeeks: true
    };

    $scope.dateOptions = {
      dateDisabled: disabled,
      formatYear: 'yy',
      maxDate: new Date(2020, 5, 22),
      minDate: new Date(),
      startingDay: 1
    };

    // Disable weekend selection
    function disabled(data) {
      var date = data.date,
        mode = data.mode;
      return mode === 'day' && (date.getDay() === 0 || date.getDay() === 6);
    }

    $scope.toggleMin = function () {
      $scope.inlineOptions.minDate = $scope.inlineOptions.minDate ? null : new Date();
      $scope.dateOptions.minDate = $scope.inlineOptions.minDate;
    };

    $scope.toggleMin();

    $scope.open1 = function () {
      console.log("open1");
      $scope.popup1.opened = true;
    };

    $scope.open2 = function () {
      console.log("open2")
      $scope.popup2.opened = true;
    };

    $scope.setDate = function (year, month, day) {
      $scope.dt = new Date(year, month, day);
    };

    $scope.formats = ['dd-MMMM-yyyy', 'yyyy/MM/dd', 'dd.MM.yyyy', 'shortDate'];
    $scope.format = $scope.formats[2];
    $scope.altInputFormats = ['M!/d!/yyyy'];

    $scope.popup1 = {
      opened: false
    };

    $scope.popup2 = {
      opened: false
    };

    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    var afterTomorrow = new Date();
    afterTomorrow.setDate(tomorrow.getDate() + 1);
    $scope.events = [
      {
        date: tomorrow,
        status: 'full'
      },
      {
        date: afterTomorrow,
        status: 'partially'
      }
    ];

    function getDayClass(data) {
      var date = data.date,
        mode = data.mode;
      if (mode === 'day') {
        var dayToCheck = new Date(date).setHours(0, 0, 0, 0);

        for (var i = 0; i < $scope.events.length; i++) {
          var currentDay = new Date($scope.events[i].date).setHours(0, 0, 0, 0);

          if (dayToCheck === currentDay) {
            return $scope.events[i].status;
          }
        }
      }

      return '';
    }
  });  // END - angularApp.controller
  //********************************************************************************************************************

  google.load('visualization', '1', {packages: ['controls', 'charteditor']});

  function loadSensorData(sensor_id, sensorName) {
    $.ajax({
      type: 'GET',
      url: '/getsensordata/' + sensor_id,
      success: function (result) {
        console.log("result.length -> " + result.length);
        mSensorData = result;

        google.setOnLoadCallback(drawData(sensorName));
      }
    });
  };

  function drawData(sensorName) {
    var data = new google.visualization.DataTable();
    //data.addColumn('number', 'X');
    data.addColumn('datetime', 'Date');
    data.addColumn('number', sensorName);
    //data.addColumn('number', 'test soba_2');

    //console.log("current TS: " + new Date().toUTCString());
    console.log("current TS locale: " + new Date().toLocaleString());
    //console.time('Timer name');

    for (var i = 0; i < mSensorData.length; i += 1) {
      let sVal = parseFloat(mSensorData[i].sensor_value);
      //console.log("val[" + i + "] -> " + sVal);

      let sTS = parseInt(mSensorData[i].timestamp * 1000);
      let sTSDate = new Date(sTS);
      data.addRow([sTSDate, sVal]);
    }

    var chartOptions = {
      height: 400,
      chartArea: {left: 70, right: 70, top: 50, width: "95%"},
      legend: {position: 'top', alignment: 'end'},
      interpolateNulls: false,
      series: {
        1: {
          type: "line",
          interpolateNulls: false
        }
      },
      hAxis: {
        title: '',
        format: 'HH:mm:ss',
        gridlines: {
          count: 8,
          color: "#8c8c8c"
        },
        baselineColor: '#40cc34',
        textStyle: {
          color: '#01579b',
          fontSize: 18,
          fontName: 'Arial',
          bold: false,
          italic: false
        }
      },
      vAxis: {
        title: 'Temperatura',
        textStyle: {
          color: '#8b5f0a',
          fontSize: 18,
          bold: false
        },
        titleTextStyle: {
          color: '#8b5f0a',
          fontSize: 18,
          bold: true
        },
        minValue: 0,
        viewWindow: {
          min: 0
        },
        gridlines: {
          count: 8,
          color: "#8C8C8C"
        },
        baselineColor: '#222222'
      },
      colors: ['#c53d47', '#31925a'],
      backgroundColor: '#f6f6f6'
    };

    var dash = new google.visualization.Dashboard(document.getElementById('dashboard_div'));

    var control = new google.visualization.ControlWrapper({
      controlType: 'ChartRangeFilter',
      containerId: 'control_div',
      options: {
        filterColumnIndex: 0,
        ui: {
          chartOptions: {
            height: 60,
            width: "95%",
            chartArea: {
              left: 70,
              right: 70,
              width: '90%'
            },
            backgroundColor: '#dfdfdf'
          },
          chartView: {
            columns: [0, 1]
          }
        }
      }
    });

    var chart = new google.visualization.ChartWrapper({
      chartType: 'LineChart',
      containerId: 'chart_div',
    });

    function setOptions(wrapper) {
      wrapper.setOptions(chartOptions);
    }

    setOptions(chart);

    dash.bind([control], [chart]);
    dash.draw(data);
    google.visualization.events.addListener(control, 'statechange', function () {
      var v = control.getState();
      let dateStartStr = v.range.start;
      let dateEndStr = v.range.end;
      document.getElementById('chart_range_span').innerHTML = dateStartStr + '  to  ' + dateEndStr;
      return 0;
    });
  }

</script>

<body ng-app="myApp" ng-controller="getSensorCtrl">
<header>
    <% include ../partials/header %>
</header>

<div class="main_container" style="display: block">
    <div class="row">
        <div class="col-md-2">
            <h5>Select sensor to monitor</h5>
            <select class="selectpicker"
                    ng-change="updateSelectBox()"
                    ng-model="selSensor"
                    ng-options="sensor.sensor_name for sensor in mSensorList">
            </select>
        </div>
        <div class="col-md-2">
            <h5>FROM DATE:</h5>
            <p class="input-group">
                <input type="text" class="form-control" uib-datepicker-popup="{{format}}" ng-model="dt"
                       is-open="popup1.opened" datepicker-options="dateOptions" ng-required="true" close-text="Close"
                       alt-input-formats="altInputFormats"/>
                <span class="input-group-btn">
            <button type="button" class="btn btn-default" ng-click="open1()">
                <i class="glyphicon glyphicon-calendar"></i>
            </button>
          </span>
            </p>
        </div>

        <div class="col-md-2">
            <h5>TO DATE:</h5>
            <p class="input-group">
                <input type="text" class="form-control" uib-datepicker-popup ng-model="dt" is-open="popup2.opened"
                       datepicker-options="dateOptions" ng-required="true" close-text="Close"/>
                <span class="input-group-btn">
            <button type="button" class="btn btn-default" ng-click="open2()">
                <i class="glyphicon glyphicon-calendar"></i>
            </button>
          </span>
            </p>
        </div>
    </div>
    <div class="row">
        <div class="center">
            <div class="col-md-12">
                <!-- <div id="chart_div"></div> -->
                <div id="dashboard_div">
                    <div id="chart_div" style="display: block;"></div>
                    <div id="control_div"></div>
                    <p><span id='chart_range_span'></span></p>
                </div>
            </div>
        </div>
    </div>


</div>


<footer class="container-fluid text-center">
    <% include ../partials/footer %>
</footer>

</body>
</html>
