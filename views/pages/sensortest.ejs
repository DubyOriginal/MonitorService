<!-- views/pamonitoring.ejs.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
    <% include ../partials/head %>

    <script src="angular/angular.js"></script>
    <script src="ng-table-bundle/ng-table.min.js"></script>
    <script src="/angular-google-chart/ng-google-chart.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<script type="text/javascript">
  var angularApp = angular.module('myApp', ["ngTable"]);
  angularApp.controller('getSensorCtrl', function ($scope, NgTableParams, $http) {
    $scope.mDefaultSensor = {sensor_id: "11 33 55 77", sensor_type: "temp"};
    $scope.mSensorList = [];
    $scope.defaultSensor = function () {
      $scope.tempSensor = angular.copy($scope.mDefaultSensor);
    };
    $scope.defaultSensor();

    $scope.getData = function () {
      console.log("getData CLICKED!");

      $http({
        method: 'GET',
        url: 'getlatestsensormeasurement/' + $scope.tempSensor.sensor_id + "/" + $scope.tempSensor.sensor_type
      }).then(function (response) {
        $scope.mSensorList = response.data;
      }, function (error) {
        console.log("getlatestsensormeasurement ERROR: " + error);
      });

    };
    $scope.getData();  //initial data load

    $scope.usersTable = new NgTableParams({}, {dataset: $scope.mSensorList});

    <!-- ........ GAUGE VIEW........ -->
    google.charts.load('current', {'packages': ['gauge']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {

      var data = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['sensor 1', 80],
        ['sensor 2', 55],
      ]);

      var options = {
        width: 400, height: 120,
        greenFrom: 50, greenTo: 80,
        yellowFrom: 80, yellowTo: 90,
        redFrom: 90, redTo: 100,
        minorTicks: 5
      };

      var chart = new google.visualization.Gauge(document.getElementById('gauge_div'));
      let sen1val = $scope.mSensorList[0].sensor_value;
      data.setValue(0, 1, sen1val);
      chart.draw(data, options);

    }

  });


</script>

<body class="container" ng-app="myApp">

<header>
    <% include ../partials/header %>
</header>

<main>
    <div class="row">
        <div class="container" class="col-sm-12">
            <div class="jumbotron">
                <h3>latest sensor data</h3>

                <div ng-controller="getSensorCtrl">
                    <div class="row">
                        <div class="col-sm-4">
                            <form novalidate>
                                Sensor ID:<br>
                                <input type="text" ng-model="tempSensor.sensor_id"><br>
                                Sensor type:<br>
                                <input type="text" ng-model="tempSensor.sensor_type">
                                <br><br>

                                <button ng-click="defaultSensor()">RESET</button>
                                <button ng-click="getData()">Get sensor data</button>
                            </form>
                        </div>


                        <div class="col-sm-8">
                            <h4>Analog temp.</h4>
                            <div id="gauge_div" style="width: 400px; height: 120px;"></div>
                        </div>
                    </div>

                    <table ng-table="usersTable" class="table table-striped">
                        <tr ng-repeat="sensor in mSensorList">
                            <td data-title="'Date'">{{ sensor.rtimestamp }}</td>
                            <td data-title="'Sensor ID'">{{ sensor.sensor_id }}</td>
                            <td data-title="'Type'">{{ sensor.sensor_type }}</td>
                            <td data-title="'Name'">{{ sensor.sensor_name }}</td>
                            <td data-title="'Value'">{{ sensor.sensor_value }}</td>
                        </tr>
                    </table>


                </div>
            </div>
        </div>
    </div>
</main>

<footer class="container-fluid bg-4 text-center">
    <% include ../partials/footer %>
</footer>

</body>
</html>
